stages:
  - build
  - docker

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

build:
  stage: build
  image: gradle:8.5.0-jdk21  # Updated to JDK 21 version
  script:
    - ./gradlew clean build -x test --no-daemon
  artifacts:
    paths:
      - build/libs/order-management-0.0.1-SNAPSHOT.jar
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always

docker_build_and_push:
  stage: docker
  image: docker:24.0.2
  services:
    - docker:dind
  needs:
    - job: build
      artifacts: true
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - mkdir docker-context
    - cp build/libs/order-management-0.0.1-SNAPSHOT.jar docker-context/app.jar
    - cp Dockerfile docker-context/
    - cd docker-context
    - docker build -t "$CI_REGISTRY_IMAGE:latest"
    - docker push "$CI_REGISTRY_IMAGE:latest"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
